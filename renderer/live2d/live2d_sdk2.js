function ModelSettingJson(){this.NAME="name";this.ID="id";this.MODEL="model";this.TEXTURES="textures";this.HIT_AREAS="hit_areas";this.PHYSICS="physics";this.POSE="pose";this.EXPRESSIONS="expressions";this.MOTION_GROUPS="motions";this.SOUND="sound";this.FADE_IN="fade_in";this.FADE_OUT="fade_out";this.LAYOUT="layout";this.INIT_PARAM="init_param";this.INIT_PARTS_VISIBLE="init_parts_visible";this.VALUE="val";this.FILE="file";this.json={}}ModelSettingJson.prototype.loadModelSetting=function(path,callback){var thisRef=this;var pm=Live2DFramework.getPlatformManager();pm.loadBytes(path,function(buf){var str=String.fromCharCode.apply(null,new Uint8Array(buf));thisRef.json=JSON.parse(str);callback()})};ModelSettingJson.prototype.getTextureFile=function(n){if(this.json[this.TEXTURES]==null||this.json[this.TEXTURES][n]==null){return null}return this.json[this.TEXTURES][n]};ModelSettingJson.prototype.getModelFile=function(){return this.json[this.MODEL]};ModelSettingJson.prototype.getTextureNum=function(){if(this.json[this.TEXTURES]==null){return 0}return this.json[this.TEXTURES].length};ModelSettingJson.prototype.getHitAreaNum=function(){if(this.json[this.HIT_AREAS]==null){return 0}return this.json[this.HIT_AREAS].length};ModelSettingJson.prototype.getHitAreaID=function(n){if(this.json[this.HIT_AREAS]==null||this.json[this.HIT_AREAS][n]==null){return null}return this.json[this.HIT_AREAS][n][this.ID]};ModelSettingJson.prototype.getHitAreaName=function(n){if(this.json[this.HIT_AREAS]==null||this.json[this.HIT_AREAS][n]==null){return null}return this.json[this.HIT_AREAS][n][this.NAME]};ModelSettingJson.prototype.getPhysicsFile=function(){return this.json[this.PHYSICS]};ModelSettingJson.prototype.getPoseFile=function(){return this.json[this.POSE]};ModelSettingJson.prototype.getExpressionNum=function(){return(this.json[this.EXPRESSIONS]==null)?0:this.json[this.EXPRESSIONS].length};ModelSettingJson.prototype.getExpressionFile=function(n){if(this.json[this.EXPRESSIONS]==null){return null
}return this.json[this.EXPRESSIONS][n][this.FILE]};ModelSettingJson.prototype.getExpressionName=function(n){if(this.json[this.EXPRESSIONS]==null){return null}return this.json[this.EXPRESSIONS][n][this.NAME]};ModelSettingJson.prototype.getLayout=function(){return this.json[this.LAYOUT]};ModelSettingJson.prototype.getInitParamNum=function(){return(this.json[this.INIT_PARAM]==null)?0:this.json[this.INIT_PARAM].length};ModelSettingJson.prototype.getMotionNum=function(name){if(this.json[this.MOTION_GROUPS]==null||this.json[this.MOTION_GROUPS][name]==null){return 0}return this.json[this.MOTION_GROUPS][name].length};ModelSettingJson.prototype.getMotionFile=function(name,n){if(this.json[this.MOTION_GROUPS]==null||this.json[this.MOTION_GROUPS][name]==null||this.json[this.MOTION_GROUPS][name][n]==null){return null}return this.json[this.MOTION_GROUPS][name][n][this.FILE]};ModelSettingJson.prototype.getMotionSound=function(name,n){if(this.json[this.MOTION_GROUPS]==null||this.json[this.MOTION_GROUPS][name]==null||this.json[this.MOTION_GROUPS][name][n]==null||this.json[this.MOTION_GROUPS][name][n][this.SOUND]==null){return null}return this.json[this.MOTION_GROUPS][name][n][this.SOUND]};ModelSettingJson.prototype.getMotionFadeIn=function(name,n){if(this.json[this.MOTION_GROUPS]==null||this.json[this.MOTION_GROUPS][name]==null||this.json[this.MOTION_GROUPS][name][n]==null||this.json[this.MOTION_GROUPS][name][n][this.FADE_IN]==null){return 1000}return this.json[this.MOTION_GROUPS][name][n][this.FADE_IN]};ModelSettingJson.prototype.getMotionFadeOut=function(name,n){if(this.json[this.MOTION_GROUPS]==null||this.json[this.MOTION_GROUPS][name]==null||this.json[this.MOTION_GROUPS][name][n]==null||this.json[this.MOTION_GROUPS][name][n][this.FADE_OUT]==null){return 1000}return this.json[this.MOTION_GROUPS][name][n][this.FADE_OUT]};ModelSettingJson.prototype.getInitParamID=function(n){if(this.json[this.INIT_PARAM]==null||this.json[this.INIT_PARAM][n]==null){return null}return this.json[this.INIT_PARAM][n][this.ID]
};ModelSettingJson.prototype.getInitParamValue=function(n){if(this.json[this.INIT_PARAM]==null||this.json[this.INIT_PARAM][n]==null){return NaN}return this.json[this.INIT_PARAM][n][this.VALUE]};ModelSettingJson.prototype.getInitPartsVisibleNum=function(){return(this.json[this.INIT_PARTS_VISIBLE]==null)?0:this.json[this.INIT_PARTS_VISIBLE].length};ModelSettingJson.prototype.getInitPartsVisibleID=function(n){if(this.json[this.INIT_PARTS_VISIBLE]==null||this.json[this.INIT_PARTS_VISIBLE][n]==null){return null}return this.json[this.INIT_PARTS_VISIBLE][n][this.ID]};ModelSettingJson.prototype.getInitPartsVisibleValue=function(n){if(this.json[this.INIT_PARTS_VISIBLE]==null||this.json[this.INIT_PARTS_VISIBLE][n]==null){return NaN}return this.json[this.INIT_PARTS_VISIBLE][n][this.VALUE]};
function MatrixStack(){}MatrixStack.matrixStack=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];MatrixStack.depth=0;MatrixStack.currentMatrix=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];MatrixStack.tmp=new Array(16);MatrixStack.reset=function(){this.depth=0};MatrixStack.loadIdentity=function(){for(var i=0;i<16;i++){this.currentMatrix[i]=(i%5==0)?1:0}};MatrixStack.push=function(){var offset=this.depth*16;var nextOffset=(this.depth+1)*16;if(this.matrixStack.length<nextOffset+16){this.matrixStack.length=nextOffset+16}for(var i=0;i<16;i++){this.matrixStack[nextOffset+i]=this.currentMatrix[i]}this.depth++};MatrixStack.pop=function(){this.depth--;if(this.depth<0){myError("Invalid matrix stack.");this.depth=0}var offset=this.depth*16;for(var i=0;i<16;i++){this.currentMatrix[i]=this.matrixStack[offset+i]}};MatrixStack.getMatrix=function(){return this.currentMatrix};MatrixStack.multMatrix=function(matNew){var i,j,k;for(i=0;i<16;i++){this.tmp[i]=0}for(i=0;i<4;i++){for(j=0;j<4;j++){for(k=0;k<4;k++){this.tmp[i+j*4]+=this.currentMatrix[i+k*4]*matNew[k+j*4]}}}for(i=0;i<16;i++){this.currentMatrix[i]=this.tmp[i]}};
var thisRef=this;window.onerror=function(msg,url,line,col,error){var errmsg="file:"+url+"<br>line:"+line+" "+msg;l2dError(errmsg)};function sampleApp1(){this.platform=window.navigator.platform.toLowerCase();this.live2DMgr=new LAppLive2DManager();this.isDrawStart=false;this.gl=null;this.canvas=null;this.dragMgr=null;this.viewMatrix=null;this.projMatrix=null;this.deviceToScreen=null;this.drag=false;this.oldLen=0;this.lastMouseX=0;this.lastMouseY=0;this.isModelShown=false;initL2dCanvas("glcanvas");init()}function initL2dCanvas(canvasId){this.canvas=document.getElementById(canvasId);if(this.canvas.addEventListener){this.canvas.addEventListener("mousewheel",mouseEvent,false);this.canvas.addEventListener("click",mouseEvent,false);this.canvas.addEventListener("mousedown",mouseEvent,false);this.canvas.addEventListener("mousemove",mouseEvent,false);this.canvas.addEventListener("mouseup",mouseEvent,false);this.canvas.addEventListener("mouseout",mouseEvent,false);this.canvas.addEventListener("contextmenu",mouseEvent,false);this.canvas.addEventListener("touchstart",touchEvent,false);this.canvas.addEventListener("touchend",touchEvent,false);this.canvas.addEventListener("touchmove",touchEvent,false)}}function init(){var width=this.canvas.width;var height=this.canvas.height;this.dragMgr=new L2DTargetPoint();var ratio=height/width;var left=LAppDefine.VIEW_LOGICAL_LEFT;var right=LAppDefine.VIEW_LOGICAL_RIGHT;var bottom=-ratio;var top=ratio;this.viewMatrix=new L2DViewMatrix();this.viewMatrix.setScreenRect(left,right,bottom,top);this.viewMatrix.setMaxScreenRect(LAppDefine.VIEW_LOGICAL_MAX_LEFT,LAppDefine.VIEW_LOGICAL_MAX_RIGHT,LAppDefine.VIEW_LOGICAL_MAX_BOTTOM,LAppDefine.VIEW_LOGICAL_MAX_TOP);this.viewMatrix.setMaxScale(LAppDefine.VIEW_MAX_SCALE);this.viewMatrix.setMinScale(LAppDefine.VIEW_MIN_SCALE);this.projMatrix=new L2DMatrix44();this.projMatrix.multScale(1,(width/height));this.deviceToScreen=new L2DMatrix44();this.deviceToScreen.multTranslate(-width/2,-height/2);this.deviceToScreen.multScale(2/width,-2/width);
this.gl=getWebGLContext();if(!this.gl){l2dError("Failed to create WebGL context.");return}Live2D.setGL(this.gl);this.gl.clearColor(0,0,0,0);this.live2DMgr.reloadFlg=true;this.live2DMgr.count++;this.live2DMgr.changeModel(this.gl);startDraw()}function startDraw(){if(!this.isDrawStart){this.isDrawStart=true;(function tick(){draw();var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame;requestAnimationFrame(tick,this.canvas)})()}}function draw(){MatrixStack.reset();MatrixStack.loadIdentity();this.dragMgr.update();this.live2DMgr.setDrag(this.dragMgr.getX(),this.dragMgr.getY());this.gl.clear(this.gl.COLOR_BUFFER_BIT);MatrixStack.multMatrix(projMatrix.getArray());MatrixStack.multMatrix(viewMatrix.getArray());MatrixStack.push();for(var i=0;i<this.live2DMgr.numModels();i++){var model=this.live2DMgr.getModel(i);if(model==null){return}if(model.initialized&&!model.updating){model.update();model.draw(this.gl);if(!this.isModelShown&&i==this.live2DMgr.numModels()-1){this.isModelShown=!this.isModelShown}}}MatrixStack.pop()}function modelScaling(scale){var isMaxScale=thisRef.viewMatrix.isMaxScale();var isMinScale=thisRef.viewMatrix.isMinScale();thisRef.viewMatrix.adjustScale(0,0,scale);if(!isMaxScale){if(thisRef.viewMatrix.isMaxScale()){thisRef.live2DMgr.maxScaleEvent()}}if(!isMinScale){if(thisRef.viewMatrix.isMinScale()){thisRef.live2DMgr.minScaleEvent()}}}function modelTurnHead(event){thisRef.drag=true;var rect=event.target.getBoundingClientRect();var sx=transformScreenX(event.clientX-rect.left);var sy=transformScreenY(event.clientY-rect.top);var vx=transformViewX(event.clientX-rect.left);var vy=transformViewY(event.clientY-rect.top);if(LAppDefine.DEBUG_MOUSE_LOG){l2dLog("onMouseDown device( x:"+event.clientX+" y:"+event.clientY+" ) view( x:"+vx+" y:"+vy+")")}thisRef.lastMouseX=sx;thisRef.lastMouseY=sy;thisRef.dragMgr.setPoint(vx,vy);thisRef.live2DMgr.tapEvent(vx,vy)}function followPointer(event){var rect=event.target.getBoundingClientRect();
var sx=transformScreenX(event.clientX-rect.left);var sy=transformScreenY(event.clientY-rect.top);var vx=transformViewX(event.clientX-rect.left);var vy=transformViewY(event.clientY-rect.top);if(LAppDefine.DEBUG_MOUSE_LOG){l2dLog("onMouseMove device( x:"+event.clientX+" y:"+event.clientY+" ) view( x:"+vx+" y:"+vy+")")}if(thisRef.drag){thisRef.lastMouseX=sx;thisRef.lastMouseY=sy;thisRef.dragMgr.setPoint(vx,vy)}}function lookFront(){if(thisRef.drag){thisRef.drag=false}thisRef.dragMgr.setPoint(0,0)}function mouseEvent(e){e.preventDefault();if(e.type=="mousewheel"){if(e.clientX<0||thisRef.canvas.clientWidth<e.clientX||e.clientY<0||thisRef.canvas.clientHeight<e.clientY){return}if(e.wheelDelta>0){modelScaling(1.1)}else{modelScaling(0.9)}}else{if(e.type=="mousedown"){if("button" in e&&e.button!=0){return}modelTurnHead(e)}else{if(e.type=="mousemove"){followPointer(e)}else{if(e.type=="mouseup"){if("button" in e&&e.button!=0){return}lookFront()}else{if(e.type=="mouseout"){lookFront()}else{if(e.type=="contextmenu"){}}}}}}}function touchEvent(e){e.preventDefault();var touch=e.touches[0];if(e.type=="touchstart"){if(e.touches.length==1){modelTurnHead(touch)}}else{if(e.type=="touchmove"){followPointer(touch);if(e.touches.length==2){var touch1=e.touches[0];var touch2=e.touches[1];var len=Math.pow(touch1.pageX-touch2.pageX,2)+Math.pow(touch1.pageY-touch2.pageY,2);if(thisRef.oldLen-len<0){modelScaling(1.025)}else{modelScaling(0.975)}thisRef.oldLen=len}}else{if(e.type=="touchend"){lookFront()}}}}function transformViewX(deviceX){var screenX=this.deviceToScreen.transformX(deviceX);return viewMatrix.invertTransformX(screenX)}function transformViewY(deviceY){var screenY=this.deviceToScreen.transformY(deviceY);return viewMatrix.invertTransformY(screenY)}function transformScreenX(deviceX){return this.deviceToScreen.transformX(deviceX)}function transformScreenY(deviceY){return this.deviceToScreen.transformY(deviceY)}function getWebGLContext(){var NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl"];
for(var i=0;i<NAMES.length;i++){try{var ctx=this.canvas.getContext(NAMES[i],{premultipliedAlpha:true});if(ctx){return ctx}}catch(e){}}return null}function l2dLog(msg){if(!LAppDefine.DEBUG_LOG){return}var myconsole=document.getElementById("myconsole");myconsole.innerHTML=myconsole.innerHTML+"<br>"+msg;console.log(msg)}function l2dError(msg){if(!LAppDefine.DEBUG_LOG){return}l2dLog("<span style='color:red'>"+msg+"</span>");console.error(msg)};
function PlatformManager(){}PlatformManager.prototype.loadBytes=function(path,callback){var request=new XMLHttpRequest();request.open("GET",path,true);request.responseType="arraybuffer";request.onload=function(){switch(request.status){case 200:callback(request.response);break;default:console.error("Failed to load ("+request.status+") : "+path);break}};request.send(null)};PlatformManager.prototype.loadString=function(path){this.loadBytes(path,function(buf){return buf})};PlatformManager.prototype.loadLive2DModel=function(path,callback){var model=null;this.loadBytes(path,function(buf){model=Live2DModelWebGL.loadModel(buf);callback(model)})};PlatformManager.prototype.loadTexture=function(model,no,path,callback){var loadedImage=new Image();loadedImage.src=path;var thisRef=this;loadedImage.onload=function(){var canvas=document.getElementById("glcanvas");var gl=getWebGLContext(canvas,{premultipliedAlpha:true});var texture=gl.createTexture();if(!texture){console.error("Failed to generate gl texture name.");return -1}if(model.isPremultipliedAlpha()==false){gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1)}gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,1);gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,loadedImage);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);model.setTexture(no,texture);texture=null;if(typeof callback=="function"){callback()}};loadedImage.onerror=function(){console.error("Failed to load image : "+path)}};PlatformManager.prototype.jsonParseFromBytes=function(buf){var jsonStr;var bomCode=new Uint8Array(buf,0,3);if(bomCode[0]==239&&bomCode[1]==187&&bomCode[2]==191){jsonStr=String.fromCharCode.apply(null,new Uint8Array(buf,3))}else{jsonStr=String.fromCharCode.apply(null,new Uint8Array(buf))}var jsonObj=JSON.parse(jsonStr);return jsonObj};PlatformManager.prototype.log=function(txt){console.log(txt)
};
function LAppModel(){L2DBaseModel.prototype.constructor.call(this);this.modelHomeDir="";this.modelSetting=null;this.tmpMatrix=[]}LAppModel.prototype=new L2DBaseModel();LAppModel.prototype.load=function(gl,modelSettingPath,callback){this.setUpdating(true);this.setInitialized(false);this.modelHomeDir=modelSettingPath.substring(0,modelSettingPath.lastIndexOf("/")+1);this.modelSetting=new ModelSettingJson();var thisRef=this;this.modelSetting.loadModelSetting(modelSettingPath,function(){var path=thisRef.modelHomeDir+thisRef.modelSetting.getModelFile();thisRef.loadModelData(path,function(model){for(var i=0;i<thisRef.modelSetting.getTextureNum();i++){var texPaths=thisRef.modelHomeDir+thisRef.modelSetting.getTextureFile(i);thisRef.loadTexture(i,texPaths,function(){if(thisRef.isTexLoaded){if(thisRef.modelSetting.getExpressionNum()>0){thisRef.expressions={};for(var j=0;j<thisRef.modelSetting.getExpressionNum();j++){var expName=thisRef.modelSetting.getExpressionName(j);var expFilePath=thisRef.modelHomeDir+thisRef.modelSetting.getExpressionFile(j);thisRef.loadExpression(expName,expFilePath)}}else{thisRef.expressionManager=null;thisRef.expressions={}}if(thisRef.eyeBlink==null){thisRef.eyeBlink=new L2DEyeBlink()}if(thisRef.modelSetting.getPhysicsFile()!=null){thisRef.loadPhysics(thisRef.modelHomeDir+thisRef.modelSetting.getPhysicsFile())}else{thisRef.physics=null}if(thisRef.modelSetting.getPoseFile()!=null){thisRef.loadPose(thisRef.modelHomeDir+thisRef.modelSetting.getPoseFile(),function(){thisRef.pose.updateParam(thisRef.live2DModel)})}else{thisRef.pose=null}if(thisRef.modelSetting.getLayout()!=null){var layout=thisRef.modelSetting.getLayout();if(layout["width"]!=null){thisRef.modelMatrix.setWidth(layout["width"])}if(layout["height"]!=null){thisRef.modelMatrix.setHeight(layout["height"])}if(layout["x"]!=null){thisRef.modelMatrix.setX(layout["x"])}if(layout["y"]!=null){thisRef.modelMatrix.setY(layout["y"])}if(layout["center_x"]!=null){thisRef.modelMatrix.centerX(layout["center_x"])
}if(layout["center_y"]!=null){thisRef.modelMatrix.centerY(layout["center_y"])}if(layout["top"]!=null){thisRef.modelMatrix.top(layout["top"])}if(layout["bottom"]!=null){thisRef.modelMatrix.bottom(layout["bottom"])}if(layout["left"]!=null){thisRef.modelMatrix.left(layout["left"])}if(layout["right"]!=null){thisRef.modelMatrix.right(layout["right"])}}for(var j=0;j<thisRef.modelSetting.getInitParamNum();j++){thisRef.live2DModel.setParamFloat(thisRef.modelSetting.getInitParamID(j),thisRef.modelSetting.getInitParamValue(j))}for(var j=0;j<thisRef.modelSetting.getInitPartsVisibleNum();j++){thisRef.live2DModel.setPartsOpacity(thisRef.modelSetting.getInitPartsVisibleID(j),thisRef.modelSetting.getInitPartsVisibleValue(j))}thisRef.live2DModel.saveParam();thisRef.preloadMotionGroup(LAppDefine.MOTION_GROUP_IDLE);thisRef.mainMotionManager.stopAllMotions();thisRef.setUpdating(false);thisRef.setInitialized(true);if(typeof callback=="function"){callback()}}})}})})};LAppModel.prototype.release=function(gl){var pm=Live2DFramework.getPlatformManager();gl.deleteTexture(pm.texture)};LAppModel.prototype.preloadMotionGroup=function(name){var thisRef=this;for(var i=0;i<this.modelSetting.getMotionNum(name);i++){var file=this.modelSetting.getMotionFile(name,i);this.loadMotion(file,this.modelHomeDir+file,function(motion){motion.setFadeIn(thisRef.modelSetting.getMotionFadeIn(name,i));motion.setFadeOut(thisRef.modelSetting.getMotionFadeOut(name,i))})}};LAppModel.prototype.update=function(){if(this.live2DModel==null){if(LAppDefine.DEBUG_LOG){console.error("Failed to update.")}return}var timeMSec=UtSystem.getUserTimeMSec()-this.startTimeMSec;var timeSec=timeMSec/1000;var t=timeSec*2*Math.PI;if(this.mainMotionManager.isFinished()){this.startRandomMotion(LAppDefine.MOTION_GROUP_IDLE,LAppDefine.PRIORITY_IDLE)}this.live2DModel.loadParam();var update=this.mainMotionManager.updateParam(this.live2DModel);if(!update){if(this.eyeBlink!=null){this.eyeBlink.updateParam(this.live2DModel)}}this.live2DModel.saveParam();
if(this.expressionManager!=null&&this.expressions!=null&&!this.expressionManager.isFinished()){this.expressionManager.updateParam(this.live2DModel)}this.live2DModel.addToParamFloat("PARAM_ANGLE_X",this.dragX*30,1);this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",this.dragY*30,1);this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",(this.dragX*this.dragY)*-30,1);this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",this.dragX*10,1);this.live2DModel.addToParamFloat("PARAM_EYE_BALL_X",this.dragX,1);this.live2DModel.addToParamFloat("PARAM_EYE_BALL_Y",this.dragY,1);this.live2DModel.addToParamFloat("PARAM_ANGLE_X",Number((15*Math.sin(t/6.5345))),0.5);this.live2DModel.addToParamFloat("PARAM_ANGLE_Y",Number((8*Math.sin(t/3.5345))),0.5);this.live2DModel.addToParamFloat("PARAM_ANGLE_Z",Number((10*Math.sin(t/5.5345))),0.5);this.live2DModel.addToParamFloat("PARAM_BODY_ANGLE_X",Number((4*Math.sin(t/15.5345))),0.5);this.live2DModel.setParamFloat("PARAM_BREATH",Number((0.5+0.5*Math.sin(t/3.2345))),1);if(this.physics!=null){this.physics.updateParam(this.live2DModel)}if(this.lipSync==null){this.live2DModel.setParamFloat("PARAM_MOUTH_OPEN_Y",this.lipSyncValue)}if(this.pose!=null){this.pose.updateParam(this.live2DModel)}this.live2DModel.update()};LAppModel.prototype.setRandomExpression=function(){var tmp=[];for(var name in this.expressions){tmp.push(name)}var no=parseInt(Math.random()*tmp.length);this.setExpression(tmp[no])};LAppModel.prototype.startRandomMotion=function(name,priority){var max=this.modelSetting.getMotionNum(name);var no=parseInt(Math.random()*max);this.startMotion(name,no,priority)};LAppModel.prototype.startMotion=function(name,no,priority){var motionName=this.modelSetting.getMotionFile(name,no);if(motionName==null||motionName==""){if(LAppDefine.DEBUG_LOG){console.error("Failed to motion.")}return}if(priority==LAppDefine.PRIORITY_FORCE){this.mainMotionManager.setReservePriority(priority)}else{if(!this.mainMotionManager.reserveMotion(priority)){if(LAppDefine.DEBUG_LOG){console.log("Motion is running.")
}return}}var thisRef=this;var motion;if(this.motions[name]==null){this.loadMotion(null,this.modelHomeDir+motionName,function(mtn){motion=mtn;thisRef.setFadeInFadeOut(name,no,priority,motion)})}else{motion=this.motions[name];thisRef.setFadeInFadeOut(name,no,priority,motion)}};LAppModel.prototype.setFadeInFadeOut=function(name,no,priority,motion){var motionName=this.modelSetting.getMotionFile(name,no);motion.setFadeIn(this.modelSetting.getMotionFadeIn(name,no));motion.setFadeOut(this.modelSetting.getMotionFadeOut(name,no));if(LAppDefine.DEBUG_LOG){console.log("Start motion : "+motionName)}if(this.modelSetting.getMotionSound(name,no)==null){this.mainMotionManager.startMotionPrio(motion,priority)}else{var soundName=this.modelSetting.getMotionSound(name,no);var snd=document.createElement("audio");snd.src=this.modelHomeDir+soundName;if(LAppDefine.DEBUG_LOG){console.log("Start sound : "+soundName)}snd.play();this.mainMotionManager.startMotionPrio(motion,priority)}};LAppModel.prototype.setExpression=function(name){var motion=this.expressions[name];if(LAppDefine.DEBUG_LOG){console.log("Expression : "+name)}this.expressionManager.startMotion(motion,false)};LAppModel.prototype.draw=function(gl){MatrixStack.push();MatrixStack.multMatrix(this.modelMatrix.getArray());this.tmpMatrix=MatrixStack.getMatrix();this.live2DModel.setMatrix(this.tmpMatrix);this.live2DModel.draw();MatrixStack.pop()};LAppModel.prototype.hitTest=function(id,testX,testY){var len=this.modelSetting.getHitAreaNum();for(var i=0;i<len;i++){if(id==this.modelSetting.getHitAreaName(i)){var drawID=this.modelSetting.getHitAreaID(i);return this.hitTestSimple(drawID,testX,testY)}}return false};
var LAppDefine={DEBUG_LOG:true,DEBUG_MOUSE_LOG:false,VIEW_MAX_SCALE:2,VIEW_MIN_SCALE:0.8,VIEW_LOGICAL_LEFT:-1,VIEW_LOGICAL_RIGHT:1,VIEW_LOGICAL_MAX_LEFT:-2,VIEW_LOGICAL_MAX_RIGHT:2,VIEW_LOGICAL_MAX_BOTTOM:-2,VIEW_LOGICAL_MAX_TOP:2,PRIORITY_NONE:0,PRIORITY_IDLE:1,PRIORITY_NORMAL:2,PRIORITY_FORCE:3,BACK_IMAGE_NAME:"assets/image/back_class_normal.png",MODEL_HARU:"assets/live2d/mod/mod.model.json",MOTION_GROUP_IDLE:"idle",MOTION_GROUP_TAP_BODY:"tap_body",MOTION_GROUP_FLICK_HEAD:"flick_head",MOTION_GROUP_PINCH_IN:"pinch_in",MOTION_GROUP_PINCH_OUT:"pinch_out",MOTION_GROUP_SHAKE:"shake",HIT_AREA_HEAD:"head",HIT_AREA_BODY:"body"};
function LAppLive2DManager(){this.models=[];this.count=-1;this.reloadFlg=false;Live2D.init();Live2DFramework.setPlatformManager(new PlatformManager)}LAppLive2DManager.prototype.createModel=function(){var model=new LAppModel();this.models.push(model);return model};LAppLive2DManager.prototype.changeModel=function(gl){if(this.reloadFlg){this.reloadFlg=false;var no=parseInt(this.count%5);var thisRef=this;this.releaseModel(1,gl);this.releaseModel(0,gl);this.createModel();this.models[0].load(gl,LAppDefine.MODEL_HARU)}};LAppLive2DManager.prototype.getModel=function(no){if(no>=this.models.length){return null}return this.models[no]};LAppLive2DManager.prototype.releaseModel=function(no,gl){if(this.models.length<=no){return}this.models[no].release(gl);delete this.models[no];this.models.splice(no,1)};LAppLive2DManager.prototype.numModels=function(){return this.models.length};LAppLive2DManager.prototype.setDrag=function(x,y){for(var i=0;i<this.models.length;i++){this.models[i].setDrag(x,y)}};LAppLive2DManager.prototype.maxScaleEvent=function(){if(LAppDefine.DEBUG_LOG){console.log("Max scale event.")}for(var i=0;i<this.models.length;i++){this.models[i].startRandomMotion(LAppDefine.MOTION_GROUP_PINCH_IN,LAppDefine.PRIORITY_NORMAL)}};LAppLive2DManager.prototype.minScaleEvent=function(){if(LAppDefine.DEBUG_LOG){console.log("Min scale event.")}for(var i=0;i<this.models.length;i++){this.models[i].startRandomMotion(LAppDefine.MOTION_GROUP_PINCH_OUT,LAppDefine.PRIORITY_NORMAL)}};LAppLive2DManager.prototype.tapEvent=function(x,y){if(LAppDefine.DEBUG_LOG){console.log("tapEvent view x:"+x+" y:"+y)}for(var i=0;i<this.models.length;i++){if(this.models[i].hitTest(LAppDefine.HIT_AREA_HEAD,x,y)){if(LAppDefine.DEBUG_LOG){console.log("Tap face.")}this.models[i].setRandomExpression()}else{if(this.models[i].hitTest(LAppDefine.HIT_AREA_BODY,x,y)){if(LAppDefine.DEBUG_LOG){console.log("Tap body."+" models["+i+"]")}this.models[i].startRandomMotion(LAppDefine.MOTION_GROUP_TAP_BODY,LAppDefine.PRIORITY_NORMAL)
}}}return true};
